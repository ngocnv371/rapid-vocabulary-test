-- initialize Supabase tables (PostgreSQL) with RLS

-- profiles
CREATE TABLE IF NOT EXISTS public.profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  name text,
  email text,
  avatar_url text
);

CREATE OR REPLACE FUNCTION public.handle_new_auth_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO public.profiles (id, name, avatar_url, email)
  VALUES (NEW.id, NULL, NULL)
  ON CONFLICT (id) DO NOTHING;

  RETURN NEW;
END;
$$;


DROP TRIGGER IF EXISTS trigger_handle_new_auth_user ON auth.users;

CREATE TRIGGER trigger_handle_new_auth_user
AFTER INSERT ON auth.users
FOR EACH ROW
EXECUTE FUNCTION public.handle_new_auth_user();

ALTER TABLE IF EXISTS public.profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public to read all profiles"
  ON public.profiles
  FOR SELECT
  TO public
  USING (true);
CREATE POLICY "Allow authenticated to update their profile"
  ON public.profiles
  FOR UPDATE
  TO authenticated
  USING ((auth.uid())::uuid = id)
  WITH CHECK ((auth.uid())::uuid = id);

-- categories
CREATE TABLE IF NOT EXISTS public.categories (
  id              TEXT PRIMARY KEY,
  name            TEXT NOT NULL UNIQUE,
  icon            TEXT
);
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public to read all categories" ON public.categories
  FOR SELECT
  TO public
  USING (true);

CREATE TABLE IF NOT EXISTS public.words (
  id              BIGSERIAL PRIMARY KEY,
  word            TEXT NOT NULL,
  category        TEXT NOT NULL REFERENCES public.categories(id) ON DELETE CASCADE,
  language        TEXT NOT NULL,
  meaning         TEXT NOT NULL
);
ALTER TABLE public.words ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public to read all words" ON public.words
  FOR SELECT
  TO public
  USING (true);

-- table scores for leaderboard
CREATE TABLE IF NOT EXISTS public.scores (
  id              BIGSERIAL PRIMARY KEY,
  user_id         uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  category        TEXT NOT NULL REFERENCES public.categories(id) ON DELETE CASCADE,
  score           INT NOT NULL,
  created_at      timestamptz NOT NULL DEFAULT now()
);
ALTER TABLE public.scores ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow authenticated to insert scores" ON public.scores
  FOR INSERT
  TO authenticated
  WITH CHECK (true);
CREATE POLICY "Allow public to read all scores" ON public.scores
  FOR SELECT
  TO public
  USING (true);
